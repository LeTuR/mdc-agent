# Implementation Plan: MDC Agent API

**Branch**: `001-mdc-agent-api` | **Date**: 2025-11-17 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-mdc-agent-api/spec.md`

**Note**: This file is generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Build a REST API that simplifies LLM agent interaction with Azure Microsoft Defender for Cloud. The API will provide agent-optimized endpoints for retrieving security recommendations, creating exemptions, assigning users with grace periods, and configuring email notifications. All responses use snake_case naming and stay under 1MB to fit LLM context windows.

**Technical Approach**: Python FastAPI service with Azure SDK integration, implementing retry logic, authentication via Azure Identity, and email notifications via SMTP/Azure Communication Services.

## Technical Context

**Language/Version**: Python 3.11
**Primary Dependencies**: FastAPI 0.104+, Azure SDK (azure-mgmt-security, azure-identity), Pydantic 2.x, HTTPX (async HTTP client)
**Storage**: PostgreSQL 15+ (for assignments, notification rules, audit logs); Azure Defender for Cloud (source of truth for recommendations/exemptions)
**Testing**: pytest 7.x, pytest-asyncio, Testcontainers (for integration tests)
**Target Platform**: Linux server (Docker container), deployable to Azure Container Apps or AKS
**Project Type**: single (API-only service)
**Performance Goals**: <5s for 1000 recommendations, <10s batch assignment (50 items), <200ms p95 for individual operations
**Constraints**: Responses <1MB, snake_case fields, retry logic with exponential backoff, graceful Azure rate limit handling
**Scale/Scope**: Support 100+ Azure subscriptions, 10k+ recommendations, 1k+ users, 500+ notification rules

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with `.specify/memory/constitution.md` principles:

- [x] **API-First Design**: Feature starts with OpenAPI/contract definition (contracts/ directory) - will be created in Phase 1
- [x] **Agent-Optimized Interface**: Response schemas are LLM-friendly (snake_case, actionable fields, <1MB) - specified in requirements FR-014, FR-020
- [x] **Conventional Commits**: Branch follows `001-mdc-agent-api` pattern (numbered feature branch per project conventions)
- [x] **Azure MDC Integration**: Azure SDK usage is abstracted in service layer with retry logic - per constitution IV and FR-017, FR-018
- [x] **Test-Driven Development (TDD)**: Tests written first (contract → integration → unit), verified to fail before implementation - will follow TDD workflow
- [x] **GitHub Actions CI/CD**: Workflows defined in `.github/workflows/` (ci.yml, release.yml) - will be created during implementation

**Complexity Violations**: None

## Project Structure

### Documentation (this feature)

```text
specs/001-mdc-agent-api/
├── plan.md              # This file
├── research.md          # Phase 0 output (Azure SDK patterns, notification approaches)
├── data-model.md        # Phase 1 output (entities: Recommendation, Assignment, Exemption, NotificationRule)
├── quickstart.md        # Phase 1 output (developer setup guide)
├── contracts/           # Phase 1 output (OpenAPI 3.1 specs)
│   ├── recommendations.yaml
│   ├── exemptions.yaml
│   ├── assignments.yaml
│   └── notifications.yaml
└── checklists/
    └── requirements.md  # Already created
```

### Source Code (repository root)

```text
src/
├── models/
│   ├── recommendation.py      # Pydantic models for recommendations
│   ├── exemption.py           # Pydantic models for exemptions
│   ├── assignment.py          # Pydantic models for user assignments
│   └── notification.py        # Pydantic models for notification rules
├── services/
│   ├── azure_defender.py      # Azure MDC SDK abstraction with retry logic
│   ├── assignment_service.py  # User assignment management
│   ├── notification_service.py # Email notification handling
│   └── storage_service.py     # PostgreSQL persistence layer
├── api/
│   ├── v1/
│   │   ├── recommendations.py # Recommendation endpoints
│   │   ├── exemptions.py      # Exemption endpoints
│   │   ├── assignments.py     # Assignment endpoints
│   │   └── notifications.py   # Notification endpoints
│   └── middleware/
│       ├── error_handler.py   # Consistent error responses
│       └── auth.py            # Azure AD authentication
├── db/
│   ├── migrations/            # Alembic database migrations
│   └── models.py              # SQLAlchemy models for assignments/notifications
└── main.py                    # FastAPI application entry point

tests/
├── contract/
│   ├── test_recommendations_contract.py
│   ├── test_exemptions_contract.py
│   ├── test_assignments_contract.py
│   └── test_notifications_contract.py
├── integration/
│   ├── test_recommendation_workflow.py
│   ├── test_assignment_workflow.py
│   └── test_notification_workflow.py
└── unit/
    ├── test_azure_defender_service.py
    ├── test_assignment_service.py
    └── test_notification_service.py

.github/
└── workflows/
    ├── ci.yml                 # Lint, test, build on PR
    └── release.yml            # Semantic-release on main merge
```

**Structure Decision**: Single project structure selected (Option 1). This is a pure API service with no frontend component. The structure follows FastAPI conventions with clear separation between models (data), services (business logic), and API (HTTP layer). Tests are organized by type (contract, integration, unit) per TDD requirements.

## Complexity Tracking

No complexity violations - all constitution principles are followed without exceptions.

## Phase 0: Research & Technical Decisions

**Status**: Pending - will be executed after this plan is written

**Research Tasks**:
1. Azure Defender for Cloud SDK patterns for recommendation retrieval with filtering
2. Azure exemption API best practices and permission requirements
3. Email notification approaches (SMTP vs Azure Communication Services)
4. PostgreSQL schema design for assignments with grace period tracking
5. Retry strategy patterns for Azure API rate limiting
6. Authentication flow with Azure DefaultAzureCredential
7. Batch operation patterns for multi-recommendation assignments
8. OpenAPI 3.1 spec generation with FastAPI

**Output**: `research.md` with decisions and rationale for each area

## Phase 1: Design Artifacts

**Status**: Pending - will be executed after research.md is complete

**Deliverables**:
1. **data-model.md**: Entity definitions
   - Security Recommendation (from Azure with assignment fields)
   - Exemption (Azure exemption metadata)
   - User Assignment (PostgreSQL-backed)
   - Notification Rule (PostgreSQL-backed)

2. **contracts/**: OpenAPI 3.1 specifications
   - `GET /v1/recommendations` - list with filters
   - `POST /v1/exemptions` - create exemption
   - `POST /v1/assignments` - assign user to recommendation
   - `POST /v1/assignments/batch` - batch assignment
   - `POST /v1/notifications/rules` - create notification rule
   - `GET /v1/notifications/rules` - list rules
   - `PUT /v1/notifications/rules/{id}` - update rule
   - `DELETE /v1/notifications/rules/{id}` - delete rule

3. **quickstart.md**: Developer setup guide
   - Prerequisites (Python 3.11, Docker, Azure credentials)
   - Environment variables (Azure subscription ID, credentials, database URL)
   - Running locally (poetry install, database migrations, FastAPI dev server)
   - Running tests (pytest with coverage)

## Next Steps

After this planning phase completes:

1. Execute Phase 0: Generate `research.md` with Azure SDK patterns and technical decisions
2. Execute Phase 1: Generate `data-model.md` and `contracts/*.yaml`
3. Execute Phase 1: Generate `quickstart.md`
4. Update agent context file with technology stack
5. Ready for `/speckit.tasks` to generate implementation tasks following TDD workflow
